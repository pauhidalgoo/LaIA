<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(-45deg, #1a1a1a, #2a2a2a, #1a1a1a, #2d2d2d);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .message-container {
            max-height: calc(100vh - 280px);
        }
        .user-message {
            background: rgba(59, 130, 246, 0.1);
        }
        .assistant-message {
            background: rgba(255, 255, 255, 0.05);
        }
        .system-message {
            background: rgba(34, 197, 94, 0.1);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">AI Assistant</h1>
            <p class="text-gray-400">Ask questions, upload documents, or search the web</p>
        </div>

        <!-- Chat Messages -->
        <div class="glass-effect rounded-lg p-4 mb-4 message-container overflow-y-auto">
            <div id="messages" class="space-y-4">
                <!-- Messages will be inserted here -->
            </div>
        </div>

        <!-- Input Area -->
        <div class="glass-effect rounded-lg p-4">
            <div class="flex items-center gap-4">
                <label class="cursor-pointer">
                    <input type="file" 
                           id="fileInput" 
                           class="hidden" 
                           accept=".pdf,image/*">
                    <i class="fas fa-file-pdf text-blue-400 hover:text-blue-300 text-xl"></i>
                </label>
                
                <input type="text" 
                       id="messageInput" 
                       class="flex-1 px-4 py-2 rounded-lg bg-white/10 border-0 focus:ring-2 focus:ring-blue-500 outline-none"
                       placeholder="Type your message...">
                
                <button id="sendButton" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center gap-2">
                    <i class="fas fa-paper-plane"></i>
                    Send
                </button>
                <button id="clearContextButton" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">Clear Context</button>
                <button id="ttsToggleButton" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200">TTS On</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>

    <script>
        const sessionId = "{{ session_id }}";
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const fileInput = document.getElementById('fileInput');

        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-lg ${message.role}-message`;
            
            let content = `<p class="mb-2">${message.content}</p>`;
            
            if (message.audio_file) {
                content += `
                    <div class="mt-2">
                        <audio controls class="w-full">
                            <source src="/audio/${message.audio_file}" type="audio/wav">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = content;
            return messageDiv;
        }

        function updateChat(messages) {
            messagesContainer.innerHTML = '';
            messages.forEach(message => {
                messagesContainer.appendChild(createMessageElement(message));
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        const ttsToggleButton = document.getElementById('ttsToggleButton');
            let ttsEnabled = true; // Initial state: TTS is on

            ttsToggleButton.addEventListener('click', () => {
                ttsEnabled = !ttsEnabled; // Toggle TTS state
                ttsToggleButton.textContent = ttsEnabled ? 'TTS On' : 'TTS Off';
            });



        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: message,
                        message_type: 'text',
                        tts_enabled: ttsEnabled
                    })
                });
                
                const data = await response.json();
                if (data.history) {
                    updateChat(data.history);
                }
            } catch (error) {
                console.error('Error sending message:', error);
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }
        const clearContextButton = document.getElementById('clearContextButton');
        clearContextButton.addEventListener('click', () => {
                clearContext()
            });
        async function clearContext() {
            try {
                const response = await fetch('/clear-context', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded' // Correct content type
                    },
                    body: `session_id=${sessionId}`
                });
                const data = await response.json();

                if (data.history) {
                    updateChat(data.history)
                }

            } catch (error) {
                console.error("Error clearing context", error);
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('session_id', sessionId);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.history) {
                    updateChat(data.history);
                }
            } catch (error) {
                console.error('Error uploading file:', error);
            }
        }

        function addMessageToChat(message) {
            messagesContainer.appendChild(createMessageElement(message));
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        const socket = io('/chat', { query: { session_id: sessionId } }); // Use namespace and query

        socket.on('chat_update', (data) => {
            updateChat(data.history);
        });


        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        fileInput.addEventListener('change', handleFileUpload);

        // Initial system message
        updateChat([{
            role: 'system',
            content: 'Welcome! You can ask questions, search the web, or upload a PDF document for analysis.',
            timestamp: new Date().toISOString()
        }]);
    </script>
</body>
</html>